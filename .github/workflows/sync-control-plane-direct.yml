name: Sync control plane directly to cluster
on:
  workflow_dispatch:
    inputs:
      operation:
        required: true
        description: "Delete, Update or create"
        type: string
      triggeringUser:
        required: true
        description: "The email of the triggering user"
        type: string
      runId:
        required: true
        description: "Port's Run ID"
        type: string
      manifest:
        required: true
        description: "The K8s manifest generated by Port"
        type: string
jobs:
  synchornize-control-plane:
    runs-on: ubuntu-latest
    steps:
      - name: checkout
        uses: actions/checkout@v2
      - uses: actions/setup-python@v5
        with:
          python-version: '3.10' 
      - uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          operation: PATCH_RUN
          runId: ${{ inputs.runId }} 
          icon: GithubActions
          logMessage: "Synchronizing process of resource state to cluster started üèÉüèª‚Äç‚ôÇÔ∏è"
      - name: Write manifest to file
        run: |
            mkdir output
            echo '${{ inputs.manifest }}' | jq .  > temp.json
            yaml_data=$(yq -p json -o yaml temp.json)
            echo "$yaml_data" > ./output/output.yaml
      - uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          operation: PATCH_RUN
          runId: ${{ inputs.runId }} 
          icon: GithubActions
          logMessage: "Applying resource state to cluster üöÄ"
      - name: apply to cluster
        uses: steebchen/kubectl@v2.0.0
        if: ${{ inputs.operation != 'DELETE' }}
        with: 
          config: ${{ secrets.KUBE_CONFIG }}
          command: apply -f ./output
      - name: delete from cluster
        uses: steebchen/kubectl@v2.0.0
        if: ${{ inputs.operation == 'DELETE' }}
        with: 
          config: ${{ secrets.KUBE_CONFIG }}
          command: delete -f ./output 
      - uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          operation: PATCH_RUN
          runId: ${{ inputs.runId }} 
          icon: GithubActions
          logMessage: "Waiting for the resource state to be ready üïí"
      - name: Check resource readiness
        uses: steebchen/kubectl@v2.0.0
        if: ${{ inputs.operation != 'DELETE' }}
        with: 
          config: ${{ secrets.KUBE_CONFIG }}
          command: wait --for condition=ready --timeout=5m -f ./output
      - uses: port-labs/port-github-action@v1
        if: success()
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          operation: PATCH_RUN
          runId: ${{ inputs.runId }} 
          icon: GithubActions
          logMessage: "Synchronizing process of resource state to cluster completed üèÅ‚úÖ"
      - uses: port-labs/port-github-action@v1
        if: failure()
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          operation: PATCH_RUN
          runId: ${{ inputs.runId }} 
          icon: GithubActions
          logMessage: | 
            Synchronizing process of resource state to cluster failed ‚ùå 
            Check the job run logs in Github to learn more üìú
              ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}


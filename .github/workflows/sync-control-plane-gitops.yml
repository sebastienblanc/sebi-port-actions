name: Sync control plane gitops
permissions:
  contents: write
  pull-requests: write
on:
  workflow_dispatch:
    inputs:
      operation:
        required: true
        description: "Delete, Update or create"
        type: string
      triggeringUser:
        required: true
        description: "The email of the triggering user"
        type: string
      runId:
        required: true
        description: "Port's Run ID"
        type: string
      manifest:
        required: true
        description: "The K8s manifest generated by Port"
        type: string
      folder:
        required: true
        description: Folder where the resource will be stored
        default: "./argocd-apps/control-plane/manifests"
        type: string

jobs:
  open-pr:
    runs-on: ubuntu-latest
    steps:
      - name: checkout
        uses: actions/checkout@v2
      - uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          operation: PATCH_RUN
          runId: ${{inputs.runId}} 
          icon: GithubActions
          logMessage: "Creating branch with name runs/${{inputs.runId}} üèÉüèª‚Äç‚ôÇÔ∏è"
      - name: create-branch
        run: |
          git checkout -b runs/${{inputs.runId}}
      - uses: actions/setup-python@v5
        with:
          python-version: '3.10' 
      - name: Update manifests folder
        run: |
            echo '${{ inputs.manifest }}' | jq .  > temp.json
            yaml_data=$(yq -p json -o yaml temp.json)
            name=$(echo '${{ inputs.manifest }}' | jq .metadata.name)
            if [ "${{ inputs.operation }}" = "DELETE" ]; then
              rm -f "${{ inputs.folder }}/$name".yaml
            else
              echo "$yaml_data" > "${{ inputs.folder }}/$name".yaml
            fi
            rm -f temp.json
      - uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          operation: PATCH_RUN
          runId: ${{inputs.runId}} 
          icon: GithubActions
          logMessage: "Creating a PR with the changes of the new resource in folder ${{ inputs.folder }} üöÄ"
      - name: create pr 
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "GitHub Action"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          git commit -m "chore: ${{ inputs.operation }} resource by ${{ inputs.triggeringUser }}"
          git push origin runs/${{inputs.runId}}
          gh pr create --title "chore: ${{ inputs.operation }} resource" --body "This PR was created by the workflow triggered by ${{inputs.triggeringUser}}" --base main --head runs/${{inputs.runId}}
      - uses: port-labs/port-github-action@v1
        if: success()
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          operation: PATCH_RUN
          runId: ${{inputs.runId}} 
          icon: GithubActions
          logMessage: "Created a new PR succesfully ‚úÖ"
      - uses: port-labs/port-github-action@v1
        if: failure()
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          operation: PATCH_RUN
          runId: ${{inputs.runId}} 
          icon: GithubActions
          logMessage: | 
            Failed to create a new PR ‚ùå
            Check the job run logs in Github to learn more üìú:
              ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          
